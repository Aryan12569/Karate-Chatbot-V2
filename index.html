<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarateBot Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f5f5f5; }
        .sidebar { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="font-sans antialiased">

<!-- Sidebar -->
<div class="flex h-screen">
    <div class="sidebar w-64 bg-red-900 text-white flex flex-col">
        <div class="p-4 flex items-center space-x-2 border-b border-white border-opacity-20">
            <i data-feather="shield" class="w-6 h-6"></i>
            <span class="font-bold">KarateBot Admin</span>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" id="dashboardLink" class="flex items-center space-x-2 p-2 rounded-lg bg-white bg-opacity-10">
                <i data-feather="home"></i><span>Dashboard</span>
            </a>
            <a href="#" id="leadsLink" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                <i data-feather="users"></i><span>Leads</span>
            </a>
            <a href="#" id="broadcastLink" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                <i data-feather="send"></i><span>Broadcast</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-auto">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
            <button id="refreshBtn" class="flex items-center space-x-1 bg-red-900 text-white px-3 py-2 rounded-lg hover:bg-opacity-90">
                <i data-feather="refresh-cw" class="w-4 h-4"></i><span>Refresh</span>
            </button>
        </header>

        <!-- Content Sections -->
        <div class="p-4" id="content">

            <!-- Analytics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" id="analyticsCards">
                <div class="bg-white rounded-lg shadow p-6 card-hover transition-all">
                    <div class="flex justify-between items-start">
                        <div><p class="text-gray-500">Total Leads</p><h3 class="text-2xl font-bold" id="totalLeads">0</h3></div>
                        <div class="p-2 rounded-full bg-red-100"><i data-feather="users" class="w-5 h-5 text-red-900"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover transition-all">
                    <div class="flex justify-between items-start">
                        <div><p class="text-gray-500">Register Now</p><h3 class="text-2xl font-bold" id="registerNow">0</h3></div>
                        <div class="p-2 rounded-full bg-green-100"><i data-feather="check-circle" class="w-5 h-5 text-green-500"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover transition-all">
                    <div class="flex justify-between items-start">
                        <div><p class="text-gray-500">Register Later</p><h3 class="text-2xl font-bold" id="registerLater">0</h3></div>
                        <div class="p-2 rounded-full bg-yellow-100"><i data-feather="clock" class="w-5 h-5 text-yellow-500"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover transition-all">
                    <div class="flex justify-between items-start">
                        <div><p class="text-gray-500">Last Updated</p><h3 class="text-lg font-bold" id="lastUpdated">--:--:--</h3></div>
                        <div class="p-2 rounded-full bg-blue-100"><i data-feather="clock" class="w-5 h-5 text-blue-500"></i></div>
                    </div>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden mb-4" id="leadsSection" style="display:none;">
                <div class="p-4 flex justify-between items-center border-b">
                    <h3 class="font-bold text-lg">Leads</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="leadsTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Intent</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Broadcast -->
            <div class="bg-white rounded-lg shadow p-6 mb-4" id="broadcastSection" style="display:none;">
                <h3 class="font-bold text-lg mb-4">Send Custom Message</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Select Segment</label>
                        <select id="segmentSelect" class="w-full px-4 py-2 border rounded-lg">
                            <option value="all">All Leads</option>
                            <option value="register_now">Register Now</option>
                            <option value="register_later">Register Later</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Message</label>
                        <textarea id="broadcastMessage" class="w-full px-4 py-2 border rounded-lg" rows="4" placeholder="Type your message here"></textarea>
                    </div>
                    <button id="sendBroadcastBtn" class="bg-red-900 text-white py-2 px-6 rounded-lg font-medium hover:bg-opacity-90">Send Message</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    feather.replace();

    const API_URL = "https://karate-chatbot-v2.onrender.com/api/leads"; // backend endpoint

    const updateAnalytics = (leads) => {
        const total = leads.length;
        const registerNow = leads.filter(l => l.Intent === "Register Now").length;
        const registerLater = leads.filter(l => l.Intent === "Register Later").length;
        document.getElementById("totalLeads").textContent = total;
        document.getElementById("registerNow").textContent = registerNow;
        document.getElementById("registerLater").textContent = registerLater;
        document.getElementById("lastUpdated").textContent = new Date().toLocaleTimeString();
    }

    const populateLeadsTable = (leads) => {
        const tbody = document.querySelector("#leadsTable tbody");
        tbody.innerHTML = "";
        leads.forEach(lead => {
            const row = `<tr>
                <td class="px-6 py-4 whitespace-nowrap">${lead.Timestamp}</td>
                <td class="px-6 py-4 whitespace-nowrap">${lead.Name}</td>
                <td class="px-6 py-4 whitespace-nowrap">${lead.Contact}</td>
                <td class="px-6 py-4 whitespace-nowrap">${lead.Intent}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    const loadLeads = async () => {
        const res = await fetch(API_URL);
        const data = await res.json();
        updateAnalytics(data);
        populateLeadsTable(data);
    }

    // Initial load
    loadLeads();

    // Navigation
    document.getElementById("dashboardLink").addEventListener("click", () => {
        document.getElementById("analyticsCards").style.display = "grid";
        document.getElementById("leadsSection").style.display = "none";
        document.getElementById("broadcastSection").style.display = "none";
        document.getElementById("pageTitle").textContent = "Dashboard Overview";
    });
    document.getElementById("leadsLink").addEventListener("click", () => {
        document.getElementById("analyticsCards").style.display = "none";
        document.getElementById("leadsSection").style.display = "block";
        document.getElementById("broadcastSection").style.display = "none";
        document.getElementById("pageTitle").textContent = "Leads";
    });
    document.getElementById("broadcastLink").addEventListener("click", () => {
        document.getElementById("analyticsCards").style.display = "none";
        document.getElementById("leadsSection").style.display = "none";
        document.getElementById("broadcastSection").style.display = "block";
        document.getElementById("pageTitle").textContent = "Broadcast Message";
    });

    // Refresh
    document.getElementById("refreshBtn").addEventListener("click", loadLeads);

    // Broadcast
    document.getElementById("sendBroadcastBtn").addEventListener("click", async () => {
        const segment = document.getElementById("segmentSelect").value;
        const message = document.getElementById("broadcastMessage").value.trim();
        if (!message) { alert("Message cannot be empty!"); return; }
        const leadsRes = await fetch(API_URL);
        const leads = await leadsRes.json();
        let targets = [];
        if(segment === "all") targets = leads;
        else if(segment === "register_now") targets = leads.filter(l => l.Intent === "Register Now");
        else if(segment === "register_later") targets = leads.filter(l => l.Intent === "Register Later");

        // Send message to each lead via backend API
        for(const lead of targets){
            await fetch(`https://karate-chatbot-v2.onrender.com/send_message`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({to: lead.Contact, message})
            });
        }
        alert(`Message sent to ${targets.length} users!`);
        document.getElementById("broadcastMessage").value = "";
    });
</script>

</body>
</html>
