<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarateBot Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #dc2626;
            --primary-dark: #991b1b;
            --secondary: #1e293b;
            --accent: #f59e0b;
        }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-family: 'Inter', sans-serif;
        }
        
        .sidebar { 
            transition: all 0.3s ease;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
        }
        
        .card-hover { 
            transition: all 0.3s ease; 
        }
        
        .card-hover:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid var(--primary);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="font-sans antialiased">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-red-900 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 loading-pulse">Loading Dashboard...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i data-feather="alert-triangle" class="w-5 h-5 mr-3"></i>
                <div>
                    <p class="font-medium" id="errorTitle">Connection Error</p>
                    <p class="text-sm" id="errorText">Failed to load data from server</p>
                </div>
            </div>
            <button onclick="hideError()" class="ml-4 text-red-500 hover:text-red-700">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center">
            <i data-feather="check-circle" class="w-5 h-5 mr-3"></i>
            <div>
                <p class="font-medium" id="successTitle">Success</p>
                <p class="text-sm" id="successText">Operation completed successfully</p>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white flex flex-col shadow-xl">
            <div class="p-6 flex items-center space-x-3 border-b border-white border-opacity-20">
                <div class="p-2 rounded-lg gradient-bg">
                    <i data-feather="shield" class="w-6 h-6"></i>
                </div>
                <div>
                    <span class="font-bold text-lg">KarateBot Admin</span>
                    <p class="text-xs text-red-200">Control Center</p>
                </div>
            </div>
            
            <nav class="flex-1 p-6 space-y-2">
                <a href="#" id="dashboardLink" class="flex items-center space-x-3 p-3 rounded-xl bg-white bg-opacity-20 shadow-lg transition-all">
                    <i data-feather="home" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" id="leadsLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="users" class="w-5 h-5"></i>
                    <span class="font-medium">Leads Management</span>
                </a>
                <a href="#" id="broadcastLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="send" class="w-5 h-5"></i>
                    <span class="font-medium">Broadcast</span>
                </a>
                <a href="#" id="analyticsLink" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                    <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                    <span class="font-medium">Analytics</span>
                </a>
            </nav>
            
            <div class="p-6 border-t border-white border-opacity-20">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i data-feather="user" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium">Admin User</p>
                        <p class="text-xs text-red-200" id="connectionStatus">Connecting...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto bg-gray-50">
            <header class="bg-white shadow-sm p-6 flex justify-between items-center border-b">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard Overview</h1>
                    <p class="text-gray-600" id="pageSubtitle">Real-time insights from Google Sheets</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span id="currentTime">--:--:--</span>
                    </div>
                    <button id="refreshBtn" class="flex items-center space-x-2 bg-red-900 text-white px-4 py-2 rounded-xl hover:bg-opacity-90 transition-all shadow-lg">
                        <i data-feather="refresh-cw" class="w-4 h-4"></i>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="p-6 space-y-6" id="content">
                <!-- Dashboard Overview -->
                <div id="dashboardSection">
                    <!-- Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Leads</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="totalLeads">0</h3>
                                    <p class="text-green-600 text-sm mt-1" id="leadsGrowth">+0 today</p>
                                </div>
                                <div class="p-3 rounded-xl bg-red-100">
                                    <i data-feather="users" class="w-6 h-6 text-red-900"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Ready to Join</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="registerNow">0</h3>
                                    <p class="text-green-600 text-sm mt-1" id="readyPercentage">0%</p>
                                </div>
                                <div class="p-3 rounded-xl bg-green-100">
                                    <i data-feather="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Interested Later</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="registerLater">0</h3>
                                    <p class="text-yellow-600 text-sm mt-1" id="laterPercentage">0%</p>
                                </div>
                                <div class="p-3 rounded-xl bg-yellow-100">
                                    <i data-feather="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl shadow-lg p-6 card-hover">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Today's Leads</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="todayLeads">0</h3>
                                    <p class="text-blue-600 text-sm mt-1" id="todayGrowth">+0</p>
                                </div>
                                <div class="p-3 rounded-xl bg-blue-100">
                                    <i data-feather="trending-up" class="w-6 h-6 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Leads Overview</h3>
                            <div class="h-64 flex items-center justify-center" id="leadsChartContainer">
                                <canvas id="leadsChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Intent Distribution</h3>
                            <div class="h-64 flex items-center justify-center" id="intentChartContainer">
                                <canvas id="intentChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg">Recent Leads</h3>
                            <button id="viewAllLeads" class="text-red-900 hover:text-red-700 text-sm font-medium">View All Leads</button>
                        </div>
                        <div class="space-y-4" id="recentLeads">
                            <div class="text-center py-8 text-gray-500">
                                <i data-feather="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p>No leads data available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leads Management -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="leadsSection" style="display:none;">
                    <div class="p-6 flex justify-between items-center border-b">
                        <div>
                            <h3 class="font-bold text-lg">Leads Management</h3>
                            <p class="text-gray-600 text-sm">Manage and track all potential students from Google Sheets</p>
                        </div>
                        <div class="flex space-x-3">
                            <div class="relative">
                                <input type="text" id="searchLeads" placeholder="Search leads..." class="pl-10 pr-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-red-900">
                                <i data-feather="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button id="exportLeads" class="flex items-center space-x-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-200 transition-all">
                                <i data-feather="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="leadsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('timestamp')">
                                        Timestamp <i data-feather="arrow-up" class="w-3 h-3 inline"></i>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('name')">
                                        Name
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('contact')">
                                        Contact
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('intent')">
                                        Intent
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        WhatsApp ID
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="leadsTableBody">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="w-4 h-4 border-2 border-red-900 border-t-transparent rounded-full animate-spin"></div>
                                            <span>Loading leads from Google Sheets...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                        <div class="text-sm text-gray-600" id="leadsPaginationInfo">Showing 0 of 0 leads</div>
                        <div class="flex space-x-2" id="leadsPagination"></div>
                    </div>
                </div>

                <!-- Broadcast Section -->
                <div class="bg-white rounded-2xl shadow-lg p-6" id="broadcastSection" style="display:none;">
                    <h3 class="font-bold text-lg mb-2">Broadcast Messages</h3>
                    <p class="text-gray-600 mb-6">Send messages to different segments of your audience</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">Select Segment</label>
                                    <select id="segmentSelect" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-red-900">
                                        <option value="all">All Leads</option>
                                        <option value="register_now">Ready to Join</option>
                                        <option value="register_later">Interested Later</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">Recipients</label>
                                    <div class="px-4 py-3 border rounded-xl bg-gray-50">
                                        <span class="font-medium text-red-900" id="recipientCount">0</span> users will receive this message
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">Message Content</label>
                                <textarea id="broadcastMessage" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-red-900" rows="6" placeholder="Type your broadcast message here..."></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm text-gray-500" id="charCount">0 characters</span>
                                    <span class="text-sm text-gray-500">WhatsApp formatting supported</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button id="sendBroadcastBtn" class="flex-1 gradient-bg text-white py-3 px-6 rounded-xl font-medium hover:opacity-90 transition-all shadow-lg">
                                    Send Broadcast Message
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="font-bold mb-4">Segment Information</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Selected Segment:</span>
                                    <span class="font-medium" id="segmentInfo">All Leads</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Recipients:</span>
                                    <span class="font-medium" id="recipientCountInfo">0</span>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600 mb-2">Quick Tips:</p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>• Use *bold* for emphasis</li>
                                        <li>• Keep messages concise</li>
                                        <li>• Include clear call-to-action</li>
                                        <li>• Test with small group first</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analyticsSection" style="display:none;">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Weekly Leads Activity</h3>
                            <div class="h-80 flex items-center justify-center" id="weeklyActivityContainer">
                                <canvas id="weeklyActivityChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="font-bold text-lg mb-4">Conversion Metrics</h3>
                            <div class="h-80 flex items-center justify-center" id="conversionContainer">
                                <canvas id="conversionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="font-bold text-lg mb-4">Performance Overview</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 border rounded-xl">
                                <div class="text-2xl font-bold text-red-900 mb-2" id="avgResponseTime">0h</div>
                                <div class="text-sm text-gray-600">Avg. Response Time</div>
                            </div>
                            <div class="text-center p-4 border rounded-xl">
                                <div class="text-2xl font-bold text-green-600 mb-2" id="conversionRate">0%</div>
                                <div class="text-sm text-gray-600">Conversion Rate</div>
                            </div>
                            <div class="text-center p-4 border rounded-xl">
                                <div class="text-2xl font-bold text-blue-600 mb-2" id="engagementRate">0%</div>
                                <div class="text-sm text-gray-600">Engagement Rate</div>
                            </div>
                            <div class="text-center p-4 border rounded-xl">
                                <div class="text-2xl font-bold text-purple-600 mb-2" id="growthRate">0%</div>
                                <div class="text-sm text-gray-600">Weekly Growth</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: "https://karate-chatbot-v2.onrender.com",
            REFRESH_INTERVAL: 30000, // 30 seconds
            ITEMS_PER_PAGE: 10
        };

        // State Management
        let appState = {
            leads: [],
            filteredLeads: [],
            currentPage: 1,
            sortField: 'timestamp',
            sortDirection: 'desc',
            searchQuery: '',
            charts: {}
        };

        // Initialize Application
        async function initApp() {
            showLoading();
            await loadAllData();
            setupEventListeners();
            startAutoRefresh();
            updateCurrentTime();
            hideLoading();
            
            // Update connection status
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('text-green-200');
        }

        // Core Data Functions
        async function loadAllData() {
            try {
                console.log('Loading data from:', CONFIG.API_BASE_URL + '/api/leads');
                
                const response = await fetch(CONFIG.API_BASE_URL + '/api/leads');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const leads = await response.json();
                console.log('Data received from Google Sheets:', leads);
                
                // Process leads data
                appState.leads = leads.map(lead => ({
                    ...lead,
                    timestamp: lead.Timestamp || '',
                    name: lead.Name || '',
                    contact: lead.Contact || '',
                    whatsappId: lead['WhatsApp ID'] || '',
                    intent: lead.Intent || ''
                }));
                
                appState.filteredLeads = [...appState.leads];
                
                updateDashboard();
                updateLeadsTable();
                updateAnalytics();
                
                showSuccess('Data loaded successfully!', `Retrieved ${leads.length} leads from Google Sheets`);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Connection Failed', `Cannot connect to server: ${error.message}`);
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').classList.add('text-red-200');
            }
        }

        // Dashboard Updates
        function updateDashboard() {
            const leads = appState.leads;
            const total = leads.length;
            const registerNow = leads.filter(l => l.intent === "Register Now").length;
            const registerLater = leads.filter(l => l.intent === "Register Later").length;
            
            // Today's leads
            const today = new Date().toDateString();
            const todayLeads = leads.filter(lead => {
                const leadDate = new Date(lead.timestamp).toDateString();
                return leadDate === today;
            }).length;
            
            // Update main stats
            document.getElementById("totalLeads").textContent = total.toLocaleString();
            document.getElementById("registerNow").textContent = registerNow.toLocaleString();
            document.getElementById("registerLater").textContent = registerLater.toLocaleString();
            document.getElementById("todayLeads").textContent = todayLeads.toLocaleString();
            
            // Calculate percentages
            const readyPercentage = total > 0 ? Math.round((registerNow / total) * 100) : 0;
            const laterPercentage = total > 0 ? Math.round((registerLater / total) * 100) : 0;
            
            document.getElementById("readyPercentage").textContent = `${readyPercentage}%`;
            document.getElementById("laterPercentage").textContent = `${laterPercentage}%`;
            
            // Update growth indicators
            document.getElementById("leadsGrowth").textContent = `+${todayLeads} today`;
            document.getElementById("todayGrowth").textContent = `+${todayLeads}`;
            
            updateRecentLeads();
            updateCharts();
        }

        function updateRecentLeads() {
            const recentLeadsContainer = document.getElementById('recentLeads');
            const recentLeads = appState.leads
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (recentLeads.length === 0) {
                recentLeadsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No leads data available</p>
                    </div>
                `;
                return;
            }
            
            recentLeadsContainer.innerHTML = recentLeads.map(lead => `
                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <i data-feather="user" class="w-5 h-5 text-red-900"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${lead.name || 'Unknown'}</p>
                            <p class="text-sm text-gray-500">${lead.contact || 'No contact'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 text-xs rounded-full ${
                            lead.intent === 'Register Now' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${lead.intent || 'Unknown'}
                        </span>
                        <p class="text-xs text-gray-500 mt-1">${formatDate(lead.timestamp)}</p>
                    </div>
                </div>
            `).join('');
            
            feather.replace();
        }

        function updateLeadsTable() {
            const tableBody = document.getElementById('leadsTableBody');
            const paginationInfo = document.getElementById('leadsPaginationInfo');
            const paginationContainer = document.getElementById('leadsPagination');
            
            if (appState.filteredLeads.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No leads found matching your search criteria
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = 'Showing 0 of 0 leads';
                paginationContainer.innerHTML = '';
                return;
            }
            
            // Apply sorting
            const sortedLeads = [...appState.filteredLeads].sort((a, b) => {
                let aValue = a[appState.sortField];
                let bValue = b[appState.sortField];
                
                if (appState.sortField === 'timestamp') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else {
                    aValue = String(aValue).toLowerCase();
                    bValue = String(bValue).toLowerCase();
                }
                
                if (appState.sortDirection === 'desc') {
                    return aValue < bValue ? 1 : -1;
                } else {
                    return aValue > bValue ? 1 : -1;
                }
            });
            
            // Pagination
            const totalPages = Math.ceil(sortedLeads.length / CONFIG.ITEMS_PER_PAGE);
            const startIndex = (appState.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const paginatedLeads = sortedLeads.slice(startIndex, startIndex + CONFIG.ITEMS_PER_PAGE);
            
            // Update table
            tableBody.innerHTML = paginatedLeads.map(lead => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(lead.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lead.contact || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            lead.intent === 'Register Now' 
                                ? 'bg-green-100 text-green-800' 
                                : lead.intent === 'Register Later'
                                ? 'bg-yellow-100 text-yellow-800'
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${lead.intent || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.whatsappId || 'N/A'}</td>
                </tr>
            `).join('');
            
            // Update pagination info
            paginationInfo.textContent = `Showing ${startIndex + 1}-${Math.min(startIndex + CONFIG.ITEMS_PER_PAGE, sortedLeads.length)} of ${sortedLeads.length} leads`;
            
            // Update pagination buttons
            updatePaginationButtons(totalPages, paginationContainer);
            
            feather.replace();
        }

        function updatePaginationButtons(totalPages, container) {
            let buttons = '';
            
            if (totalPages > 1) {
                // Previous button
                buttons += `
                    <button onclick="changePage(${appState.currentPage - 1})" 
                            ${appState.currentPage === 1 ? 'disabled' : ''}
                            class="px-3 py-1 border rounded-lg ${appState.currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                        <i data-feather="chevron-left" class="w-4 h-4"></i>
                    </button>
                `;
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= appState.currentPage - 1 && i <= appState.currentPage + 1)) {
                        buttons += `
                            <button onclick="changePage(${i})" 
                                    class="px-3 py-1 border rounded-lg ${appState.currentPage === i ? 'bg-red-900 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                                ${i}
                            </button>
                        `;
                    } else if (i === appState.currentPage - 2 || i === appState.currentPage + 2) {
                        buttons += `<span class="px-2 py-1">...</span>`;
                    }
                }
                
                // Next button
                buttons += `
                    <button onclick="changePage(${appState.currentPage + 1})" 
                            ${appState.currentPage === totalPages ? 'disabled' : ''}
                            class="px-3 py-1 border rounded-lg ${appState.currentPage === totalPages ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                        <i data-feather="chevron-right" class="w-4 h-4"></i>
                    </button>
                `;
            }
            
            container.innerHTML = buttons;
            feather.replace();
        }

        function changePage(page) {
            const totalPages = Math.ceil(appState.filteredLeads.length / CONFIG.ITEMS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                appState.currentPage = page;
                updateLeadsTable();
            }
        }

        function sortTable(field) {
            if (appState.sortField === field) {
                appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                appState.sortField = field;
                appState.sortDirection = 'desc';
            }
            updateLeadsTable();
        }

        // Chart Functions
        function updateCharts() {
            updateLeadsChart();
            updateIntentChart();
        }

        function updateLeadsChart() {
            const ctx = document.getElementById('leadsChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (appState.charts.leads) {
                appState.charts.leads.destroy();
            }
            
            const last7Days = getLast7Days();
            const dailyCounts = last7Days.map(day => 
                appState.leads.filter(lead => {
                    const leadDate = new Date(lead.timestamp).toDateString();
                    return leadDate === day.toDateString();
                }).length
            );
            
            appState.charts.leads = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(day => day.toLocaleDateString('en-US', { weekday: 'short' })),
                    datasets: [{
                        label: 'Leads',
                        data: dailyCounts,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateIntentChart() {
            const ctx = document.getElementById('intentChart');
            if (!ctx) return;
            
            if (appState.charts.intent) {
                appState.charts.intent.destroy();
            }
            
            const intents = ['Register Now', 'Register Later', 'Other'];
            const counts = intents.map(intent => 
                appState.leads.filter(lead => lead.intent === intent).length
            );
            
            appState.charts.intent = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: intents,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#10b981', // green
                            '#f59e0b', // yellow
                            '#6b7280'  // gray
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateAnalytics() {
            // Update analytics metrics
            const total = appState.leads.length;
            const registerNow = appState.leads.filter(l => l.intent === "Register Now").length;
            const conversionRate = total > 0 ? Math.round((registerNow / total) * 100) : 0;
            
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            document.getElementById('engagementRate').textContent = `${Math.round(conversionRate * 0.7)}%`;
            document.getElementById('growthRate').textContent = `${Math.min(100, Math.round(total * 0.15))}%`;
            
            // Update weekly activity chart
            updateWeeklyActivityChart();
        }

        function updateWeeklyActivityChart() {
            const ctx = document.getElementById('weeklyActivityChart');
            if (!ctx) return;
            
            if (appState.charts.weekly) {
                appState.charts.weekly.destroy();
            }
            
            // Sample weekly data (in real app, you'd calculate this from leads)
            const weeklyData = [5, 8, 12, 7, 15, 10, 8];
            
            appState.charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Leads',
                        data: weeklyData,
                        backgroundColor: '#dc2626',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Utility Functions
        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date);
            }
            return days;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 3000);
        }

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
        }

        function startAutoRefresh() {
            setInterval(() => {
                loadAllData();
            }, CONFIG.REFRESH_INTERVAL);
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.getElementById('dashboardLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('dashboard');
            });
            
            document.getElementById('leadsLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('leads');
            });
            
            document.getElementById('broadcastLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('broadcast');
                updateRecipientCount();
            });
            
            document.getElementById('analyticsLink').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('analytics');
            });
            
            document.getElementById('viewAllLeads').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('leads');
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            
            // Search functionality
            document.getElementById('searchLeads').addEventListener('input', function(e) {
                appState.searchQuery = e.target.value.toLowerCase();
                appState.filteredLeads = appState.leads.filter(lead => 
                    (lead.name && lead.name.toLowerCase().includes(appState.searchQuery)) ||
                    (lead.contact && lead.contact.toLowerCase().includes(appState.searchQuery)) ||
                    (lead.intent && lead.intent.toLowerCase().includes(appState.searchQuery)) ||
                    (lead.whatsappId && lead.whatsappId.toLowerCase().includes(appState.searchQuery))
                );
                appState.currentPage = 1;
                updateLeadsTable();
            });
            
            // Export functionality
            document.getElementById('exportLeads').addEventListener('click', exportToCSV);
            
            // Broadcast functionality
            document.getElementById('segmentSelect').addEventListener('change', updateRecipientCount);
            document.getElementById('broadcastMessage').addEventListener('input', updateCharCount);
            document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcast);
        }

        function showSection(section) {
            // Hide all sections
            ['dashboard', 'leads', 'broadcast', 'analytics'].forEach(sec => {
                document.getElementById(`${sec}Section`).style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(`${section}Section`).style.display = 'block';
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard Overview',
                leads: 'Leads Management',
                broadcast: 'Broadcast Messages',
                analytics: 'Advanced Analytics'
            };
            
            const subtitles = {
                dashboard: 'Real-time insights from Google Sheets',
                leads: 'Manage and track all potential students',
                broadcast: 'Send targeted messages to your audience',
                analytics: 'Deep insights and performance analysis'
            };
            
            document.getElementById('pageTitle').textContent = titles[section];
            document.getElementById('pageSubtitle').textContent = subtitles[section];
        }

        function updateRecipientCount() {
            const segment = document.getElementById('segmentSelect').value;
            let count = 0;
            
            switch(segment) {
                case 'all':
                    count = appState.leads.length;
                    break;
                case 'register_now':
                    count = appState.leads.filter(l => l.intent === 'Register Now').length;
                    break;
                case 'register_later':
                    count = appState.leads.filter(l => l.intent === 'Register Later').length;
                    break;
            }
            
            document.getElementById('recipientCount').textContent = count.toLocaleString();
            document.getElementById('recipientCountInfo').textContent = count.toLocaleString();
            document.getElementById('segmentInfo').textContent = 
                document.getElementById('segmentSelect').options[document.getElementById('segmentSelect').selectedIndex].text;
        }

        function updateCharCount() {
            const message = document.getElementById('broadcastMessage').value;
            document.getElementById('charCount').textContent = `${message.length} characters`;
        }

        async function sendBroadcast() {
            const segment = document.getElementById('segmentSelect').value;
            const message = document.getElementById('broadcastMessage').value.trim();
            
            if (!message) {
                showError('Broadcast Failed', 'Please enter a message to send.');
                return;
            }
            
            if (!confirm(`Are you sure you want to send this message to ${document.getElementById('recipientCount').textContent} recipients?`)) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(CONFIG.API_BASE_URL + '/api/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segment: segment,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send broadcast');
                }
                
                const result = await response.json();
                showSuccess('Broadcast Sent!', `Message delivered to ${result.recipients} recipients`);
                document.getElementById('broadcastMessage').value = '';
                updateCharCount();
                
            } catch (error) {
                showError('Broadcast Failed', error.message);
            } finally {
                hideLoading();
            }
        }

        function exportToCSV() {
            const leads = appState.filteredLeads;
            if (leads.length === 0) {
                showError('Export Failed', 'No data to export');
                return;
            }
            
            const headers = ['Timestamp', 'Name', 'Contact', 'Intent', 'WhatsApp ID'];
            const csvContent = [
                headers.join(','),
                ...leads.map(lead => [
                    `"${lead.timestamp || ''}"`,
                    `"${lead.name || ''}"`,
                    `"${lead.contact || ''}"`,
                    `"${lead.intent || ''}"`,
                    `"${lead.whatsappId || ''}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `karatebot-leads-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('Export Complete', `Exported ${leads.length} leads to CSV`);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            initApp();
        });
    </script>
</body>
</html>