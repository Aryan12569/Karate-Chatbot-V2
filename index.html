<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KarateBot Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96 text-center">
            <h2 class="text-2xl font-bold text-gray-800">KarateBot Admin</h2>
            <input type="password" id="password" placeholder="Enter password" class="mt-4 p-2 border rounded w-full">
            <button id="loginBtn" class="mt-4 bg-red-800 text-white py-2 px-4 rounded">Login</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden h-screen flex">
        <!-- Sidebar -->
        <div class="w-64 bg-red-800 text-white flex flex-col">
            <div class="p-4 text-xl font-bold">KarateBot</div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showSection('leads')" class="w-full text-left p-2 hover:bg-red-900 rounded">Leads</button>
                <button onclick="showSection('broadcast')" class="w-full text-left p-2 hover:bg-red-900 rounded">Broadcast</button>
                <button onclick="showSection('analytics')" class="w-full text-left p-2 hover:bg-red-900 rounded">Analytics</button>
            </nav>
            <div class="p-4">
                <button id="logoutBtn" class="w-full py-2 bg-red-600 rounded">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4 overflow-auto">
            <!-- Leads Section -->
            <div id="leadsSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Leads</h2>
                <table class="min-w-full bg-white shadow rounded">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2">Timestamp</th>
                            <th class="px-4 py-2">Name</th>
                            <th class="px-4 py-2">Contact</th>
                            <th class="px-4 py-2">WhatsApp ID</th>
                            <th class="px-4 py-2">Intent</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody"></tbody>
                </table>
            </div>

            <!-- Broadcast Section -->
            <div id="broadcastSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Broadcast</h2>
                <label>Segment</label>
                <select id="segmentSelect" class="border p-2 rounded mb-2 w-full">
                    <option value="all">All Leads</option>
                    <option value="register_now">Register Now</option>
                    <option value="register_later">Register Later</option>
                </select>
                <label>Message</label>
                <textarea id="customMessage" class="border p-2 rounded mb-2 w-full" rows="4"></textarea>
                <button id="sendBroadcast" class="bg-red-800 text-white px-4 py-2 rounded">Send</button>
                <p id="broadcastStatus" class="mt-2 text-green-700 font-semibold"></p>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Analytics</h2>
                <canvas id="registrationsChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Login
        document.getElementById('loginBtn').addEventListener('click', () => {
            const pass = document.getElementById('password').value;
            if(pass === 'admin123'){
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadLeads();
                initChart();
            } else {
                alert("Incorrect password");
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('password').value = '';
        });

        function showSection(sec){
            document.getElementById('leadsSection').classList.add('hidden');
            document.getElementById('broadcastSection').classList.add('hidden');
            document.getElementById('analyticsSection').classList.add('hidden');
            if(sec === 'leads') document.getElementById('leadsSection').classList.remove('hidden');
            if(sec === 'broadcast') document.getElementById('broadcastSection').classList.remove('hidden');
            if(sec === 'analytics') document.getElementById('analyticsSection').classList.remove('hidden');
        }

        async function loadLeads(){
            const resp = await fetch('/api/leads');
            const data = await resp.json();
            const tbody = document.getElementById('leadsTableBody');
            tbody.innerHTML = '';
            data.forEach(lead => {
                tbody.innerHTML += `<tr>
                    <td class="border px-2 py-1">${lead.Timestamp}</td>
                    <td class="border px-2 py-1">${lead.Name}</td>
                    <td class="border px-2 py-1">${lead.Contact}</td>
                    <td class="border px-2 py-1">${lead["WhatsApp ID"]}</td>
                    <td class="border px-2 py-1">${lead.Intent}</td>
                </tr>`;
            });
        }

        document.getElementById('sendBroadcast').addEventListener('click', async () => {
            const segment = document.getElementById('segmentSelect').value;
            const message = document.getElementById('customMessage').value;
            const resp = await fetch('/api/broadcast', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({segment, message})
            });
            const result = await resp.json();
            document.getElementById('broadcastStatus').innerText = `Sent to ${result.sent_count} users.`;
        });

        function initChart(){
            const ctx = document.getElementById('registrationsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Nov 1','Nov 2','Nov 3','Nov 4','Nov 5','Nov 6','Nov 7'],
                    datasets: [{label:'Registrations', data:[5,8,3,7,6,10,4], backgroundColor:'#8B0000'}]
                },
                options:{responsive:true, scales:{y:{beginAtZero:true}}}
            });
        }
    </script>
</body>
</html>
